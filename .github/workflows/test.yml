name: Perl Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  test:
    name: Run Perl Tests
    runs-on: ubuntu-latest
    container:
      image: arunbear/monkworld-api-deps:0.001003
      ports:
        - 3000:3000

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Perl version
        run: |
          perl -v

      # Dependencies are pre-installed in the custom image
      - name: Verify dependencies
        run: |
          cpanm --installdeps --notest .

      - name: Make API stub executable
        run: chmod +x script/api_stub

      - name: Install jq
        run: |
          apt-get update && apt-get install -y jq

      - name: Start API stub in background
        run: |
          script/api_stub daemon -l http://*:3000 > /tmp/api_stub.log 2>&1 &
          echo "API stub started in background"
          sleep 5  # Give the server time to start
          # ... then
          # Verify the server is running
          curl -s http://localhost:3000 | jq || (echo "API stub failed to start" && exit 1)

      - name: Run tests
        env:
          MONKWORLD_AUTH_TOKEN: ${{ secrets.MONKWORLD_AUTH_TOKEN }}
          PERL5LIB: /app/lib:$PERL5LIB
        run: |
          prove -lr

      - name: Show logs if tests fail
        if: ${{ failure() }}
        run: |
          echo "=== API Logs ==="
          cat /var/tmp/monkworld.log || echo "No logs found"
